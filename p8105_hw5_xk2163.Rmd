---
title: "p8105_hw5_xk2163"
author: "Kang"
date: "2024-11-16"
output: github_document
---

```{r, message=FALSE}
library(tidyverse)
library(ggplot2)
```

# Question 2

```{r parameters_in_q2}
set.seed(123)
n = 30         
sigma = 5       
mu_values = c(0, 1, 2, 3, 4, 5, 6) # True mean values
alpha = 0.05    
n_simulations = 5000
```

In the first part, we need to define all the parameters we are goiing to use in the 

```{r}

simulate_t_test = function(mu, n, sigma, n_simulations) {
  results = replicate(n_simulations, {
    x = rnorm(n, mean = mu, sd = sigma)
    t_test = t.test(x, mu = 0)
    tidy_t = broom::tidy(t_test)
    c(mu_hat = tidy_t$estimate, p_value = tidy_t$p.value)
  }, simplify = TRUE)
  
  results_df = as.data.frame(t(results))
  names(results_df) = c("mu_hat", "p_value")
  results_df$true_mu = mu
  return(results_df)
}

all_results = lapply(mu_values, simulate_t_test, n = n, sigma = sigma, n_simulations = n_simulations)
all_results = bind_rows(all_results)

```

```{r}
power_results = all_results |>
  group_by(true_mu) |>
  summarize(power = mean(p_value < alpha))

ggplot(power_results, aes(x = true_mu, y = power)) +
  geom_line() +
  geom_point() +
  labs(title = "Power vs True Effect Size",
       x = "True Mean (mu)",
       y = "Power") +
  theme_minimal()
```


```{r}
average_results = all_results |>
  group_by(true_mu) |>
  summarize(
    avg_mu_hat = mean(mu_hat),
    avg_mu_hat_rejected = mean(mu_hat[p_value < alpha]))

ggplot(average_results, aes(x = true_mu)) +
  geom_line(aes(y = avg_mu_hat), color = "blue", size = 1.2) +
  geom_line(aes(y = avg_mu_hat_rejected), color = "red", size = 1.2) +
  geom_point(aes(y = avg_mu_hat), color = "blue") +
  geom_point(aes(y = avg_mu_hat_rejected), color = "red") +
  labs(title = "Average Estimate of Mu (Blue: All, Red: Rejected)",
       x = "True Mean (mu)",
       y = "Average Estimate") +
  theme_minimal()

```

# Question 3

# Problem 3

# Problem 2

```{r}
data_df = 
  read_csv("Data/homicide-data.csv") |> 
  janitor::clean_names() |> 
  mutate(city_state = paste(city,state, sep = ", "),
         victim_age = as.numeric(victim_age)) |> 
    select(-uid)
  
```


```{r}
city_summary =
  data_df |> 
  group_by(city_state) |> 
  summarize(
    total_homicides = n(),
    unsolved_homicides = sum(disposition %in% c("Closed without arrest", "Open/No arrest")),
    .groups = "drop")

city_summary |> 
  knitr::kable(
    caption = "Summary of Homicides and Unsolved Cases by City",
    col.names = c("City, State", "Total Homicides", "Unsolved Homicides"),
    format = "latex")
```

```{r}
baltimore_data =
  data_df |> 
  filter(city_state == "Baltimore, MD")

baltimore_total = nrow(baltimore_data)
baltimore_unsolved = sum(baltimore_data$disposition %in% c("Closed without arrest", "Open/No arrest"))

baltimore_test =
  prop.test(
  x = baltimore_unsolved,
  n = baltimore_total,
  conf.level = 0.95)

baltimore_summary = broom::tidy(baltimore_test)

baltimore_summary |> 
  select(estimate, conf.low, conf.high) |> 
  knitr::kable(
    caption = "Proportion of Unsolved Homicides in Baltimore, MD")
```

In the above result, we can clearly see that the p-value of the proportions test is way smaller than 0.05, which means we need to reject the null and conclude that the successful probability is statistically different from 0.5. And its estimate and confidence interval is shown above as well.

## For each city

```{r}
city_summary = 
  data_df |>
  group_by(city_state) |>
  summarize(
    total_homicides = n(),
    unsolved_homicides = sum(disposition %in% c("Closed without arrest", "Open/No arrest")),
    .groups = "drop"
  )

city_results =
  city_summary |>
  mutate(
    prop_test = map2(unsolved_homicides, total_homicides, ~ prop.test(.x, .y)),
    estimate = map_dbl(prop_test, ~ .x$estimate),
    conf.low = map_dbl(prop_test, ~ .x$conf.int[1]),
    conf.high = map_dbl(prop_test, ~ .x$conf.int[2]),
    p.value = map_dbl(prop_test, ~ .x$p.value)) |>
  select(city_state, estimate, conf.low, conf.high, p.value) |>
  mutate(
    significance = if_else(p.value < 0.05, "*", " "))

city_results |>
  knitr::kable(
    caption = "Proportion of Unsolved Homicides by City",
    col.names = c(
      "City, State", 
      "Proportion (Estimate)", 
      "Lower CI", 
      "Upper CI", 
      "P-Value", 
      "Significance"),format = "latex")
```

## Making Plot

```{r}
city_results = city_results |>
  arrange(desc(estimate)) |>
  mutate(city_state = factor(city_state, levels = city_state))

ggplot(city_results, aes(x = city_state, y = estimate)) +
  geom_point(size = 3, color = "blue") +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2, color = "darkgray") +
  coord_flip() + 
  labs(
    title = "Proportion of Unsolved Homicides by City",
    x = "City, State",
    y = "Proportion of Unsolved Homicides",
    caption = "Error bars represent 95% confidence intervals") +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold"))

```

